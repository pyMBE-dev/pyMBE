name: samples

on:
  schedule:
    - cron:  '20 6 5,20 * *' # biweekly at 06:20 AM UTC+00 (on the 5th and 20th of the month)
  workflow_dispatch: # manual trigger

permissions:
  contents: read # to fetch code (actions/checkout)

jobs:
  samples:
    runs-on: ubuntu-24.04
    if: ${{ github.event_name == 'schedule' && github.repository == 'pyMBE-dev/pyMBE' || github.event_name != 'schedule' }}
    env:
      FI_PROVIDER: "^psm3,psm3;ofi_rxd"
      OMPI_MCA_mtl_ofi_provider_exclude: psm3
    strategy:
      matrix:
        espresso:
          - version: "4.2.2"
            eessi: ESPResSo/4.2.2-foss-2023a
          - version: "5.0-dev"
            eessi: ESPResSo/dc87ede3f6c218bb71624460752bc8c26a271c33-foss-2023b
    name: ubuntu - ESPResSo ${{ matrix.espresso.version }}
    steps:
      - name: Setup EESSI
        uses: eessi/github-action-eessi@v3
        with:
          eessi_stack_version: "2023.06"
      - name: Checkout repository
        uses: actions/checkout@main
      - name: Install dependencies
        uses: ./.github/actions/dependencies
        with:
          modules: |-
            ${{ matrix.espresso.eessi }}
      - name: Run testsuite
        run: |
          export NUM_PROC=$(nproc)
          export OMP_PROC_BIND=false OMP_NUM_THREADS=1
          module restore pymbe
          source venv/bin/activate
          make functional_tests -j${NUM_PROC}
        shell: bash
